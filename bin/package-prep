#!/bin/bash
set -e

echo "=== Dreamink Desktop Packaging Preparation ==="

# Clean previous builds
echo "Cleaning previous builds..."
rm -rf tmp/cache
rm -rf public/assets
rm -rf app/assets/builds/*

# Install dependencies
echo "Installing dependencies..."
bundle config set --local path 'vendor/bundle'
bundle config set --local without 'development test'
bundle install
npm ci --production

# Precompile assets
echo "Precompiling assets..."
RAILS_ENV=production SECRET_KEY_BASE=dummy bundle exec rails assets:precompile

# Create storage directories
echo "Creating storage directories..."
mkdir -p storage

# Generate default database
echo "Creating production database..."
RAILS_ENV=production SECRET_KEY_BASE=dummy bundle exec rails db:create db:migrate

echo "Preparation complete!"
